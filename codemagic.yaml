workflows:
  build-hianime-webview:
    name: Build HiAnime Full Screen
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      vars:
        WEBVIEW_URL: "https://hianime.to/home" 
        APP_NAME: "HiAnime"
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
        - pattern: 'master'
    scripts:
      - name: Download & Configure Open Source Wrapper
        script: |
          echo "üßπ Clearing current directory..."
          rm -rf * rm -rf .git
          
          echo "‚¨áÔ∏è Cloning Replacement WebView..."
          git clone https://github.com/thejohncotton/ios-webview.git temp_clone
          mv temp_clone/* .
          rm -rf temp_clone

          echo "üîó Injecting URL..."
          # Replace the default URL with yours
          find . -name "*.swift" -type f -exec sed -i "" "s|https://apple.com|$WEBVIEW_URL|g" {} +
          # Just in case, try google.com too
          find . -name "*.swift" -type f -exec sed -i "" "s|https://www.google.com|$WEBVIEW_URL|g" {} +

          echo "üì± Renaming App..."
          # Find the Info.plist file automatically
          INFO_PLIST=$(find . -name "Info.plist" -maxdepth 4 | head -n 1)
          
          if [ -n "$INFO_PLIST" ]; then
            echo "Found Info.plist at: $INFO_PLIST"
            
            # LOGIC: Try to SET the name. If it fails (because it doesn't exist), ADD it instead.
            /usr/libexec/PlistBuddy -c "Set :CFBundleName $APP_NAME" "$INFO_PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleName string $APP_NAME" "$INFO_PLIST"
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $APP_NAME" "$INFO_PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string $APP_NAME" "$INFO_PLIST"
            
            echo "‚úÖ App name updated to $APP_NAME"
          else
            echo "‚ö†Ô∏è Info.plist not found, skipping rename."
          fi

          echo "üìê FIX: Make WebView Full Screen..."
          # 1. Find the main ViewController file
          VC_FILE=$(find . -name "ViewController.swift" -type f | head -n 1)
          
          if [ -n "$VC_FILE" ]; then
             echo "Found ViewController at $VC_FILE, injecting full-screen code..."
             
             # This injects the line 'webView.scrollView.contentInsetAdjustmentBehavior = .never' 
             # right after 'super.viewDidLoad()' to ignore safe area insets.
             sed -i "" '/super.viewDidLoad()/a\
             webView.scrollView.contentInsetAdjustmentBehavior = .never\
             ' "$VC_FILE"
             
             echo "‚úÖ Full screen code injected."
          else
             echo "‚ö†Ô∏è Could not find ViewController.swift to inject full-screen code."
          fi

      - name: Build Unsigned .app
        script: |
          # Automatically find the project file
          PROJECT_NAME=$(find . -name "*.xcodeproj" -maxdepth 2 | head -n 1)
          SCHEME_NAME=$(basename "$PROJECT_NAME" .xcodeproj)

          echo "üî® Building $PROJECT_NAME with scheme $SCHEME_NAME..."

          xcodebuild build \
            -project "$PROJECT_NAME" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Package .app into .ipa
        script: |
          mkdir -p Payload
          cp -r build/Build/Products/Release-iphoneos/*.app Payload/
          zip -r "HiAnime_Unsigned.ipa" Payload

    artifacts:
      - HiAnime_Unsigned.ipa
